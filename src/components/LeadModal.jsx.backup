import React, { useState, useEffect } from 'react';
import { X, User, Mail, Phone, Euro, MapPin, Calendar, Target, MessageSquare, Lock, UserCheck, UserMinus, Users, CheckCircle2, CalendarCheck, Send } from 'lucide-react';
import { assignLeadToAgent, unassignLead, updateLeadStatus } from '../services/airtable';
import { mockUsers } from '../data/users';
import ConfirmDialog from './ConfirmDialog';
import AgentSelector from './AgentSelector';
import StatusSelector from './StatusSelector';
import Toast from './Toast';

const LeadModal = ({ lead, onClose, currentUser, onLeadUpdate }) => {
  if (!lead) return null;

  const [isAssigning, setIsAssigning] = useState(false);
  const [assignmentError, setAssignmentError] = useState(null);
  const [showTakeOverConfirm, setShowTakeOverConfirm] = useState(false);
  const [showUnassignConfirm, setShowUnassignConfirm] = useState(false);
  const [showAgentSelector, setShowAgentSelector] = useState(false);
  const [showStatusSelector, setShowStatusSelector] = useState(false);

  // √âtats pour la messagerie
  const [messageText, setMessageText] = useState('');
  const [isSending, setIsSending] = useState(false);
  const [localConversation, setLocalConversation] = useState(lead.conversation || []);
  const [toast, setToast] = useState(null);

  // Synchroniser localConversation avec lead.conversation quand il change
  useEffect(() => {
    console.log('üîÑ [LeadModal] Syncing conversation for', lead.nom);
    console.log('üîÑ [LeadModal] lead.conversation length:', lead.conversation?.length || 0);
    console.log('üîÑ [LeadModal] lead.conversation:', lead.conversation);
    setLocalConversation(lead.conversation || []);
  }, [lead.conversation, lead.nom]);

  // D√©terminer le statut d'assignation
  const isAssignedToMe = lead.agent_en_charge && currentUser && lead.agent_en_charge === currentUser.name;
  const isAssignedToOther = lead.agent_en_charge && currentUser && lead.agent_en_charge !== currentUser.name;
  const isFree = !lead.agent_en_charge;
  const isManager = currentUser?.role === 'manager';

  // Liste des agents disponibles (exclure les managers)
  const availableAgents = mockUsers.filter(user => user.role === 'agent');

  // Assigner le lead √† l'utilisateur connect√©
  const handleAssignToMe = async () => {
    if (!currentUser) return;

    setIsAssigning(true);
    setAssignmentError(null);

    try {
      const updatedLead = await assignLeadToAgent(lead.id, currentUser.name);
      if (onLeadUpdate) {
        onLeadUpdate(updatedLead);
      }
    } catch (error) {
      console.error('Erreur lors de l\'assignation:', error);
      setAssignmentError('Impossible d\'assigner ce lead. Veuillez r√©essayer.');
    } finally {
      setIsAssigning(false);
    }
  };

  // R√©cup√©rer le lead (forcer l'assignation)
  const handleTakeOverClick = () => {
    setShowTakeOverConfirm(true);
  };

  const handleTakeOverConfirm = async () => {
    if (!currentUser) return;

    setIsAssigning(true);
    setAssignmentError(null);

    try {
      const updatedLead = await assignLeadToAgent(lead.id, currentUser.name);
      if (onLeadUpdate) {
        onLeadUpdate(updatedLead);
      }
    } catch (error) {
      console.error('Erreur lors de la r√©cup√©ration:', error);
      setAssignmentError('Impossible de r√©cup√©rer ce lead. Veuillez r√©essayer.');
    } finally {
      setIsAssigning(false);
    }
  };

  // D√©sassigner le lead (remettre disponible)
  const handleUnassignClick = () => {
    setShowUnassignConfirm(true);
  };

  const handleUnassignConfirm = async () => {
    if (!currentUser) return;

    setIsAssigning(true);
    setAssignmentError(null);

    try {
      const updatedLead = await unassignLead(lead.id);
      if (onLeadUpdate) {
        onLeadUpdate(updatedLead);
      }
      // Fermer la modal apr√®s d√©sassignation
      onClose();
    } catch (error) {
      console.error('Erreur lors de la d√©sassignation:', error);
      setAssignmentError('Impossible de lib√©rer ce dossier. Veuillez r√©essayer.');
    } finally {
      setIsAssigning(false);
    }
  };

  // Assigner √† un agent sp√©cifique (Manager uniquement)
  const handleAssignToAgent = async (agentName) => {
    if (!isManager) return;

    setIsAssigning(true);
    setAssignmentError(null);

    try {
      const updatedLead = await assignLeadToAgent(lead.id, agentName);
      if (onLeadUpdate) {
        onLeadUpdate(updatedLead);
      }
    } catch (error) {
      console.error('Erreur lors de l\'assignation:', error);
      setAssignmentError('Impossible d\'assigner ce lead. Veuillez r√©essayer.');
    } finally {
      setIsAssigning(false);
    }
  };

  // Changer le statut du lead
  const handleStatusChange = async (newStatus) => {
    setIsAssigning(true);
    setAssignmentError(null);

    try {
      const updatedLead = await updateLeadStatus(lead.id, newStatus);
      if (onLeadUpdate) {
        onLeadUpdate(updatedLead);
      }
    } catch (error) {
      console.error('Erreur lors du changement de statut:', error);
      setAssignmentError('Impossible de changer le statut. Veuillez r√©essayer.');
    } finally {
      setIsAssigning(false);
    }
  };

  // Programmer une visite (raccourci pour changer le statut √† "Visite Programm√©e")
  const handleScheduleVisit = async () => {
    await handleStatusChange('Visite Programm√©e');
  };

  // Envoyer un message WhatsApp
  const handleSendMessage = async () => {
    if (!messageText.trim() || isSending) return;

    const newMessage = {
      message: messageText,
      sender: 'agent', // Message envoy√© par un agent immobilier (pas Sarah)
      timestamp: new Date().toISOString()
    };

    // Action 1 : Optimistic UI - Ajouter imm√©diatement le message
    setLocalConversation(prev => [...prev, newMessage]);
    const currentMessage = messageText;
    setMessageText(''); // Action 3 : Vider le champ de texte
    setIsSending(true);

    try {
      // Action 2 : Appel API vers le webhook n8n
      const response = await fetch('https://n8n.emkai.fr/webhook-test/2a714219-3cac-4997-adc6-7ba0ae54a149', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          phone: lead.phone,
          message: currentMessage,
          recordId: lead.id
        })
      });

      if (!response.ok) {
        throw new Error('√âchec de l\'envoi du message');
      }

      // Afficher un toast de succ√®s
      setToast({
        type: 'success',
        message: 'Message envoy√© avec succ√®s'
      });

      console.log('‚úÖ Message envoy√© avec succ√®s');
    } catch (error) {
      console.error('‚ùå Erreur lors de l\'envoi du message:', error);

      // Gestion d'erreur : Retirer le message de la liste
      setLocalConversation(prev => prev.filter(msg => msg !== newMessage));

      // Afficher un toast d'erreur
      setToast({
        type: 'error',
        message: '√âchec de l\'envoi du message. Veuillez r√©essayer.'
      });

      // Remettre le message dans le champ
      setMessageText(currentMessage);
    } finally {
      setIsSending(false);
    }
  };

  // G√©rer l'envoi avec la touche Entr√©e
  const handleKeyPress = (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      handleSendMessage();
    }
  };

  // Fermer la modal quand on clique sur le backdrop
  const handleBackdropClick = (e) => {
    if (e.target === e.currentTarget) {
      onClose();
    }
  };

  return (
    <div
      className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm"
      onClick={handleBackdropClick}
    >
      <div className="relative w-full max-w-4xl max-h-[90vh] bg-white dark:bg-dark-card rounded-2xl shadow-2xl overflow-hidden">
        {/* Header */}
        <div className="sticky top-0 bg-gradient-to-r from-accent to-accent-dark p-6">
          <div className="flex justify-between items-center mb-4">
            <div className="flex items-center space-x-3">
              <User className="w-8 h-8 text-white" />
              <div>
                <h2 className="text-2xl font-bold text-white">{lead.nom}</h2>
              </div>
            </div>
            <button
              onClick={onClose}
              className="p-2 hover:bg-white/20 rounded-lg transition-colors"
            >
              <X className="w-6 h-6 text-white" />
            </button>
          </div>

          {/* Boutons d'action rapide */}
          {(isAssignedToMe || isManager) && (
            <div className="flex items-center space-x-2">
              <button
                onClick={() => setShowStatusSelector(true)}
                disabled={isAssigning}
                className="flex items-center space-x-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <CheckCircle2 className="w-4 h-4" />
                <span>Changer statut</span>
              </button>
              <button
                onClick={handleScheduleVisit}
                disabled={isAssigning}
                className="flex items-center space-x-2 px-4 py-2 bg-white/20 hover:bg-white/30 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
              >
                <CalendarCheck className="w-4 h-4" />
                <span>Programmer visite</span>
              </button>
            </div>
          )}
        </div>

        {/* Content */}
        <div className="overflow-y-auto max-h-[calc(90vh-100px)] p-6">
          {/* Bandeau d'assignation */}
          {isFree && (
            <div className="mb-6 bg-blue-50 dark:bg-blue-900/20 border-l-4 border-blue-500 p-4 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <UserCheck className="w-5 h-5 text-blue-600 dark:text-blue-400" />
                  <div>
                    <p className="text-sm font-semibold text-blue-900 dark:text-blue-100">Dossier disponible</p>
                    <p className="text-xs text-blue-700 dark:text-blue-300">Ce prospect n'est assign√© √† personne</p>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <button
                    onClick={handleAssignToMe}
                    disabled={isAssigning}
                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                  >
                    <UserCheck className="w-4 h-4" />
                    <span>{isAssigning ? 'Prise en cours...' : 'Prendre le dossier'}</span>
                  </button>
                  {isManager && (
                    <button
                      onClick={() => setShowAgentSelector(true)}
                      disabled={isAssigning}
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                      title="Assigner √† un agent"
                    >
                      <Users className="w-4 h-4" />
                      <span>Assigner √†...</span>
                    </button>
                  )}
                </div>
              </div>
              {assignmentError && (
                <p className="text-xs text-red-600 dark:text-red-400 mt-2">{assignmentError}</p>
              )}
            </div>
          )}

          {isAssignedToOther && (
            <div className="mb-6 bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <Lock className="w-5 h-5 text-red-600 dark:text-red-400" />
                  <div>
                    <p className="text-sm font-semibold text-red-900 dark:text-red-100">Dossier verrouill√©</p>
                    <p className="text-xs text-red-700 dark:text-red-300">Ce dossier est assign√© √† <span className="font-bold">{lead.agent_en_charge}</span></p>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  {!isManager ? (
                    <button
                      onClick={handleTakeOverClick}
                      disabled={isAssigning}
                      className="text-xs text-red-600 dark:text-red-400 hover:underline disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      {isAssigning ? 'R√©cup√©ration...' : 'R√©cup√©rer le dossier'}
                    </button>
                  ) : (
                    <>
                      <button
                        onClick={handleUnassignClick}
                        disabled={isAssigning}
                        className="px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white text-xs font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-1"
                        title="Lib√©rer le dossier"
                      >
                        <UserMinus className="w-3 h-3" />
                        <span>Lib√©rer</span>
                      </button>
                      <button
                        onClick={handleTakeOverClick}
                        disabled={isAssigning}
                        className="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-1"
                        title="Prendre le dossier"
                      >
                        <UserCheck className="w-3 h-3" />
                        <span>Prendre</span>
                      </button>
                      <button
                        onClick={() => setShowAgentSelector(true)}
                        disabled={isAssigning}
                        className="px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white text-xs font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-1"
                        title="R√©assigner √† un agent"
                      >
                        <Users className="w-3 h-3" />
                        <span>R√©assigner</span>
                      </button>
                    </>
                  )}
                </div>
              </div>
              {assignmentError && (
                <p className="text-xs text-red-600 dark:text-red-400 mt-2">{assignmentError}</p>
              )}
            </div>
          )}

          {isAssignedToMe && (
            <div className="mb-6 bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 rounded-lg">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <UserCheck className="w-5 h-5 text-green-600 dark:text-green-400" />
                  <div>
                    <p className="text-sm font-semibold text-green-900 dark:text-green-100">Mon Dossier</p>
                    <p className="text-xs text-green-700 dark:text-green-300">Vous g√©rez actuellement ce prospect</p>
                  </div>
                </div>
                <div className="flex items-center space-x-2">
                  <button
                    onClick={handleUnassignClick}
                    disabled={isAssigning}
                    className="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                    title="Lib√©rer le dossier"
                  >
                    <UserMinus className="w-4 h-4" />
                    <span>{isAssigning ? 'Lib√©ration...' : 'Lib√©rer le dossier'}</span>
                  </button>
                  {isManager && (
                    <button
                      onClick={() => setShowAgentSelector(true)}
                      disabled={isAssigning}
                      className="px-4 py-2 bg-purple-600 hover:bg-purple-700 text-white text-sm font-medium rounded-lg transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center space-x-2"
                      title="R√©assigner √† un agent"
                    >
                      <Users className="w-4 h-4" />
                      <span>R√©assigner</span>
                    </button>
                  )}
                </div>
              </div>
              {assignmentError && (
                <p className="text-xs text-red-600 dark:text-red-400 mt-2">{assignmentError}</p>
              )}
            </div>
          )}

          {/* Informations Essentielles */}
          <div className={`mb-6 ${(isFree || (isAssignedToOther && !isManager)) ? 'opacity-60 pointer-events-none' : ''}`}>
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <Target className="w-5 h-5 text-accent mr-2" />
              Informations Essentielles
            </h3>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="flex items-start space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border-l-4 border-accent">
                <Phone className="w-5 h-5 text-accent mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">T√©l√©phone</p>
                  <a href={`tel:${lead.phone}`} className="text-sm font-medium text-accent hover:text-accent-dark transition-colors">
                    {lead.phone}
                  </a>
                </div>
              </div>
              <div className="flex items-start space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border-l-4 border-accent">
                <Mail className="w-5 h-5 text-accent mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Email</p>
                  <a href={`mailto:${lead.email}`} className="text-sm font-medium text-accent hover:text-accent-dark transition-colors">
                    {lead.email}
                  </a>
                </div>
              </div>
              <div className="flex items-start space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border-l-4 border-accent">
                <Euro className="w-5 h-5 text-accent mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Financement</p>
                  <p className="text-sm font-medium text-gray-900 dark:text-white">{lead.budget}</p>
                </div>
              </div>
              <div className="flex items-start space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border-l-4 border-accent">
                <Target className="w-5 h-5 text-accent mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Bien</p>
                  <p className="text-sm font-medium text-gray-900 dark:text-white">{lead.bien}</p>
                </div>
              </div>
              <div className="flex items-start space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border-l-4 border-accent">
                <MapPin className="w-5 h-5 text-accent mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">Source</p>
                  <p className="text-sm font-medium text-gray-900 dark:text-white">{lead.secteur}</p>
                </div>
              </div>
              <div className="flex items-start space-x-3 p-4 bg-gray-100 dark:bg-gray-800 rounded-lg border-l-4 border-accent">
                <Calendar className="w-5 h-5 text-accent mt-0.5 flex-shrink-0" />
                <div className="flex-1">
                  <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-1">D√©lai</p>
                  <p className="text-sm font-medium text-gray-900 dark:text-white">{lead.delai}</p>
                </div>
              </div>
            </div>
          </div>

          {/* Conversation WhatsApp */}
          <div className={`${(isFree || (isAssignedToOther && !isManager)) ? 'opacity-60 pointer-events-none' : ''}`}>
            <h3 className="text-lg font-semibold text-gray-900 dark:text-white mb-4 flex items-center">
              <MessageSquare className="w-5 h-5 text-accent mr-2" />
              Conversation WhatsApp
            </h3>
            {localConversation.length === 0 ? (
              <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-8 text-center">
                <MessageSquare className="w-12 h-12 text-gray-400 mx-auto mb-3 opacity-50" />
                <p className="text-gray-500 dark:text-gray-400">
                  Aucun historique de conversation disponible
                </p>
              </div>
            ) : (
              <div className="bg-gray-50 dark:bg-gray-900/50 rounded-lg p-4 space-y-3 max-h-96 overflow-y-auto flex flex-col-reverse">
                {console.log('üé® [RENDER] Rendering', localConversation.length, 'messages')}
                {localConversation.slice().reverse().map((msg, index) => {
                  console.log('üé® [RENDER] Message', index, ':', msg.message?.substring(0, 30));
                  // Format de la date et l'heure
                  const formatDateTime = (timestamp) => {
                    if (!timestamp) return '';
                    try {
                      const date = new Date(timestamp);
                      return date.toLocaleString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit',
                      });
                    } catch (error) {
                      return '';
                    }
                  };

                  // D√©terminer le type d'exp√©diteur
                  const isSarah = msg.sender === 'bot'; // Sarah (IA Assistant)
                  const isAgent = msg.sender === 'agent'; // Agent immobilier
                  const isProspect = !isSarah && !isAgent; // Le prospect (lead)

                  // Configuration visuelle selon l'exp√©diteur
                  let senderConfig = {
                    name: lead.nom,
                    bgColor: 'bg-gray-200 dark:bg-gray-700',
                    textColor: 'text-gray-900 dark:text-white',
                    labelColor: 'text-gray-600 dark:text-gray-400',
                    alignment: 'justify-start',
                    roundedCorner: 'rounded-bl-sm',
                    timestampAlign: 'text-left'
                  };

                  if (isSarah) {
                    senderConfig = {
                      name: 'Sarah (Assistant IA)',
                      bgColor: 'bg-accent',
                      textColor: 'text-black',
                      labelColor: 'text-black/70',
                      alignment: 'justify-end',
                      roundedCorner: 'rounded-br-sm',
                      timestampAlign: 'text-right'
                    };
                  } else if (isAgent) {
                    senderConfig = {
                      name: currentUser?.name || 'Agent Immobilier',
                      bgColor: 'bg-blue-500 dark:bg-blue-600',
                      textColor: 'text-white',
                      labelColor: 'text-white/80',
                      alignment: 'justify-end',
                      roundedCorner: 'rounded-br-sm',
                      timestampAlign: 'text-right'
                    };
                  }

                  return (
                    <div
                      key={index}
                      className={`flex ${senderConfig.alignment}`}
                    >
                      <div className="flex flex-col max-w-[80%]">
                        <div
                          className={`px-4 py-2.5 rounded-2xl ${senderConfig.bgColor} ${senderConfig.textColor} ${senderConfig.roundedCorner}`}
                        >
                          <p className={`text-xs font-semibold mb-1 ${senderConfig.labelColor}`}>
                            {senderConfig.name}
                          </p>
                          <p className="text-sm leading-relaxed">{msg.message}</p>
                        </div>
                        {msg.timestamp && (
                          <p className={`text-xs text-gray-500 dark:text-gray-500 mt-1 px-2 ${senderConfig.timestampAlign}`}>
                            {formatDateTime(msg.timestamp)}
                          </p>
                        )}
                      </div>
                    </div>
                  );
                })}
              </div>
            )}

            {/* Zone d'envoi de message - uniquement si assign√© √† moi ou manager */}
            {(isAssignedToMe || isManager) && (
              <div className="mt-4">
                <div className="flex items-end space-x-2 bg-white dark:bg-gray-800 rounded-lg p-3 border-2 border-gray-300 dark:border-gray-700 focus-within:border-accent transition-colors">
                  <textarea
                    value={messageText}
                    onChange={(e) => setMessageText(e.target.value)}
                    onKeyPress={handleKeyPress}
                    placeholder="Tapez votre message..."
                    disabled={isSending}
                    className="flex-1 bg-transparent text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 text-sm resize-none focus:outline-none disabled:opacity-50"
                    rows={2}
                  />
                  <button
                    onClick={handleSendMessage}
                    disabled={!messageText.trim() || isSending}
                    className="p-2.5 bg-accent hover:bg-accent-dark text-black rounded-lg transition-all disabled:opacity-50 disabled:cursor-not-allowed flex-shrink-0"
                    title="Envoyer le message"
                  >
                    <Send className="w-5 h-5" />
                  </button>
                </div>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-2">
                  Appuyez sur Entr√©e pour envoyer, Shift + Entr√©e pour une nouvelle ligne
                </p>
              </div>
            )}
          </div>
        </div>
      </div>

      {/* Toast de notification */}
      {toast && (
        <Toast
          type={toast.type}
          message={toast.message}
          onClose={() => setToast(null)}
        />
      )}

      {/* Modals de confirmation */}
      <ConfirmDialog
        isOpen={showTakeOverConfirm}
        onClose={() => setShowTakeOverConfirm(false)}
        onConfirm={handleTakeOverConfirm}
        title="R√©cup√©rer ce dossier ?"
        message={`Ce dossier est actuellement assign√© √† ${lead.agent_en_charge}. √ätes-vous s√ªr de vouloir le r√©cup√©rer ? Cette action transf√®rera le dossier sous votre responsabilit√©.`}
        confirmText="Oui, r√©cup√©rer"
        cancelText="Annuler"
        variant="warning"
      />

      <ConfirmDialog
        isOpen={showUnassignConfirm}
        onClose={() => setShowUnassignConfirm(false)}
        onConfirm={handleUnassignConfirm}
        title="Lib√©rer ce dossier ?"
        message="√ätes-vous s√ªr de vouloir lib√©rer ce dossier ? Il redeviendra disponible pour tous les agents dans la section '√Ä Traiter'."
        confirmText="Oui, lib√©rer"
        cancelText="Annuler"
        variant="default"
      />

      {/* S√©lecteur d'agent (Manager uniquement) */}
      <AgentSelector
        isOpen={showAgentSelector}
        onClose={() => setShowAgentSelector(false)}
        onSelect={handleAssignToAgent}
        currentAgent={lead.agent_en_charge}
        availableAgents={availableAgents}
      />

      {/* S√©lecteur de statut */}
      <StatusSelector
        isOpen={showStatusSelector}
        onClose={() => setShowStatusSelector(false)}
        onSelect={handleStatusChange}
        currentStatus={lead.statut}
      />
    </div>
  );
};

export default LeadModal;
